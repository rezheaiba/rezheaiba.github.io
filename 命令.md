# Linux命令

##### Linux新建用户

```sh
# 1、使用 adduser，系统提示设置信息，除密码外一路enter
sudo adduser jiyunqi
# 2、分配sudo权限，并查看用户组
sudo usermod -aG sudo jiyunqi
groups jiyunqi
	## 生成基本目录
	sudo cp -r /etc/skel/. /home/jiyunqi
# 3、如需删除用户
sudo deluser jiyunqi
  ## 连同主目录一起删除：
	sudo deluser --remove-home jiyunqi
```

## 常用命令

##### 服务器间数据传输scp命令：

```sh
scp [option] /path user@server-ip:/path
scp -r test_dataset-20240927 yihaiyang@192.168.210.90:/storage_ssd/yihaiyang/raw_dataset/mobilelive/mobile_liveness
scp -r JsonFile/* yihaiyang@192.168.210.90:/storage_ssd/yihaiyang/raw_dataset/mobilelive/JsonFile 
```

##### zip压缩，unzip解压缩

```shell
zip -r filename.zip filename
```

```sh
unzip -d filename filename.zip
```

##### 修改软链接，例如：

```sh
cd /usr/local
sudo rm cuda
sudo ln -s cuda-11.4 cuda
```

##### 递归查看文件夹下文件数量：

```sh
find . -type f | wc -l
find . -type f | sed 's|/[^/]*$||' | sort | uniq -c  # 每个文件夹下图像数量
```

##### 批量删除包含某字符文件夹：

```sh
find . -type d -name '*某字符*' -exec rm -rf {} \;
find . -maxdepth 1 -type d -name '*某字符*' -exec rm -rf {} \;  # maxdepth表示不向下递归
```

##### tensorboard访问服务器：

```sh
tensorboard --logdir=auxiliary_supervision --host 192.168.210.138
```

##### 查看cpu

```sh
lscpu
```

##### 测试I/O速度

```sh
sudo hdparm -t /dev/sda
```

##### 快速删除文件夹

```sh
ionice -c 3 rm -rf /path/to/directory
```

##### Tmux启用鼠标滚动

```shell
# 在ctrl+b启动命令行下
: set -g mouse on
```

##### Nginx安装

```sh
# 更新
sudo apt update
# 安装
sudo apt install nginx
# 启动、状态、停止
sudo systemctl start nginx
sudo systemctl status nginx
sudo systemctl stop nginx
# 开机自启
sudo systemctl enable nginx
```



## 进程相关

##### 无进程但是显存未清空，kill所有该用户进程，比reboot快

```sh
pkill -u username 
```

##### 结束包含test.py的进程：

```
pkill -f test.py
```

##### 结束被占用端口进程：

```sh
sudo lsof -i :9999  # 找到9999端口号的进程
sudo kill -9 <PID>
# 进程过多
sudo lsof -i :9999 | awk '{print $2}' | grep -o '[0-9]*' | xargs -r sudo kill -9
```



# 环境相关操作

##### zsh安装

```sh
# 1、
sudo apt update
sudo apt install zsh -y
# 2、
chsh -s $(which zsh)
## 重新打开终端
# 3、任选
sh -c "$(curl -fsSL https://gitee.com/mirrors/oh-my-zsh/raw/master/tools/install.sh)"
sh -c "$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)"
sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
# 4、插件
git clone https://github.com/zsh-users/zsh-autosuggestions ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
git clone https://github.com/wting/autojump.git 
cd autojump
./install.py
git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ~/powerlevel10k
echo 'source ~/powerlevel10k/powerlevel10k.zsh-theme' >>~/.zshrc
# 5、配置插件
vim ~/.zshrc
设置
plugins=(git
        autojump
zsh-autosuggestions
zsh-syntax-highlighting
)
source ~/.zshrc
p10k configure # 配置p10k节目
# 好看的主题：sonicradish
```

##### Nvidia驱动安装

```sh
# 禁用nouveau，输入该命令，无输出则禁用，否则继续
lsmod | grep nouveau
# 打开禁用列表
sudo vim /etc/modprobe.d/blacklist.conf
# 最后一行加入两条命令
blacklist nouveau
options nouveau modeset=0
# 更新列表，重启机器
sudo update-initramfs -u
sudo reboot

# 如需要确定版本gcc g++，安装gcc，g++，否则在线安装NVIDIA驱动时自动下载gcc，g++。
sudo apt-get install gcc g++

# 运行以下命令来列出所有可用的驱动：
sudo apt update
ubuntu-drivers devices
# 安装推荐的驱动
sudo apt install nvidia-driver-525
# 重启
sudo reboot
```

##### NVIDIA驱动失效

```sh
# 报错：NVIDIA-SMI has failed because it couldn‘t communicate with the NVIDIA driver.Make sure that the latest NVIDIA driver is installed and running.
# 1、使用 nvcc -V 检查驱动和cuda
nvcc -V
# 2、查看已安装驱动的版本信息
ls /usr/src | grep nvidia
`假设输出为：nvidia-47.074`
# 3、驱动配置
sudo apt-get install dkms
sudo dkms install -m nvidia -v 470.74
# 4、如果执行完3后依旧无效，首先查看lsmod是否有输出（NVIDIA已加载），无输出则使用modprobe手动加载模块
lsmod | grep nvidia
sudo modprobe nvidia
```

##### CUDA安装

```markdown
# 正常来说，使用conda环境中的cuda已经可以满足需求，但是如果有编译需求，或报错OSError: CUDA_HOME environment variable is not set，则需要安装系统级CUDA
在https://developer.nvidia.com/cuda-toolkit-archive网址下选择对应系统，及对应版本cuda，按其Installation Instructions命令进行安装，例如
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin
sudo mv cuda-ubuntu2204.pin /etc/apt/preferences.d/cuda-repository-pin-600
wget https://developer.download.nvidia.com/compute/cuda/12.2.0/local_installers/cuda-repo-ubuntu2204-12-2-local_12.2.0-535.54.03-1_amd64.deb
sudo dpkg -i cuda-repo-ubuntu2204-12-2-local_12.2.0-535.54.03-1_amd64.deb
sudo cp /var/cuda-repo-ubuntu2204-12-2-local/cuda-*-keyring.gpg /usr/share/keyrings/
sudo apt-get update
sudo apt-get -y install cuda
# 安装cuda后，NVIDIA版本出现了错误，nvidia-smi命令无效。执行该命令，重新安装nvidia驱动
sudo apt-get --purge remove "*nvidia*"
# 如torch.cuda.is_available()输出为False，则sudo reboot。
```

##### Miniforge3、NVIDIA、CUDA、CUDNN环境安装

```sh
# 1、下载所需版本
Miniforge3-Linux-x86_64.sh
NVIDIA-Linux-x86_64-550.142.run
cuda_12.4.0_550.54.14_linux.run
cudnn-local-repo-ubuntu2204-9.0.0_1.0-1_amd64.deb
# 2、安装注意事项
1、sh Miniforge3-Linux-x86_64.sh，注意安装时修改安装路径，安装后修改bashrc并更新。
2、sh NVIDIA-Linux-x86_64-550.142.run
3、sh cuda_12.4.0_550.54.14_linux.run，安装前需apt-get install gcc g++，安装时注意取消勾选NVIDIA安装。
4、dpkg -i cudnn-local-repo-ubuntu2204-9.0.0_1.0-1_amd64.deb
```

##### NCCL安装

```sh
# 离线安装。
# 1、进入网址：https://developer.nvidia.com/nccl/nccl-download，下载对应版本nccl
# 2、安装开发包
sudo dpkg -i nccl-local-repo-ubuntu2204-2.26.2-cuda12.2_1.0-1_amd64.deb
# 终端会输出命令，执行。添加密钥。
sudo cp /var/nccl-local-repo-ubuntu2204-2.26.2-cuda12.2/nccl-local-A6D214C3-keyring.gpg /usr/share/keyrings/
# 更新、下载对应依赖
sudo apt update
sudo apt install libnccl2 libnccl-dev
```

##### 禁止linux内核更新

```sh
# 1、修改/etc/apt/apt.conf.d/20auto-upgrades文件
sudo vim /etc/apt/apt.conf.d/20auto-upgrades
APT::Periodic::Update-Package-Lists "0";
APT::Periodic::Unattended-Upgrade "0";
# 2、停止和禁用自动升级服务
sudo systemctl stop apt-daily.service
sudo systemctl disable apt-daily.service
sudo systemctl kill --kill-who=main apt-daily.service
sudo systemctl disable apt-daily.timer
sudo systemctl mask apt-daily.timer
sudo systemctl daemon-reload
```

##### 挂载硬盘

```python
## 插入新硬盘后，先进行硬盘分区
# 1、查看当前分区情况
lsblk
# 2、进行新硬盘的分区，过程中遇到Command (? for help):依次输入o、n、w，其余enter
sudo gdisk /dev/sdc
# 3、格式化新分区
sudo mkfs.ext4 /dev/sdc1

## 对原有硬盘不需要分区，直接挂载
# 查看硬盘的uuid
sudo ls -l /dev/disk/by-uuid
# 挂载
sudo vim /etc/fstab
UUID=`对应磁盘的uuid` /storage_ssd ext4    errors=remount-ro 0     0
```

##### ssh

```sh
# ssh目录生成
ssh-keygen
# 现成各机器密钥复制到该ip（authorized_keys权限为600）
scp ~/.ssh/authorized_keys  jiyunqi@ip:/home/jiyunqi/.ssh
# 删除本机~/.ssh/known_hosts中关于该服务器原本的密钥信息
vim ~/.ssh/known_hosts
```



# Docerk操作

##### docker安装

```sh
# 1、卸载旧版本
sudo apt-get remove docker docker-engine docker.io containerd runc
# 2、安装依赖包
sudo apt-get update
sudo apt-get install ca-certificates curl gnupg lsb-release
# 3、添加Docker官方的GPG密钥、镜像源
curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"
# 4、安装docker
sudo apt-get install docker-ce docker-ce-cli containerd.io
# 5、将用户加入docker组，即有使用权限
sudo usermod -aG docker $USER
# 6、测试
docker -v
	## 安装工具
	apt-get -y install apt-transport-https ca-certificates curl software-properties-common
	## 重启docker
	sudo service docker restart
	## 拉取镜像，这里暂时用docker.1ms.run/源，暂未设置代理
	docker pull docker pull docker.1ms.run/hello-world:latest
	## 显示镜像
	docker images
	## 创建容器
	docker run -it -d --name container-name image-name:tag /bin/bash
	## 显示容器
	docker ps -a
	docker ps(运行中)
	## 进入容器
	docker exec -it container-id /bin/bash
	## 保存、加载镜像
	docker commit container-name image-name:tag
	docker save -o tar-name.tar image-name:tag
	docker load -i tar-name.tar
	## 启动容器
	docker start container-id
	## 停止容器
	docker stop container-id
	## 删除容器
	docker rm container-id
	## 删除镜像
	docker rmi image-name:tag
```



# Conda操作

##### Conda源

```sh
# 重置源配置
conda config --remove-key channels 
# 重新添加清华源
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch/ 
conda config --set show_channel_urls yes
# 查看效果
cat ~/.condarc
```

##### Conda安装不同版本gcc、g++

```sh
# 1、首先激活虚拟环境
conda activate [name]
# 2、然后安装对应版本gcc，例如：
conda install -c conda-forge gcc=7.5.0
##如果没有对应版本，可以在https://anaconda.org/search?q=gcc中按条件搜索。
# 3、确认安装包后，列出Conda环境中的所有文件，看看是否有与GCC相关的文件：
conda list
# 4、有时GCC可能安装在别的目录中，例如$CONDA_PREFIX/bin下可能有名为x86_64-conda_cos6-linux-gnu-gcc或其他类似名称的文件。列出所有相关的文件：
ls $CONDA_PREFIX/bin | grep gcc
# 5、如果找到带有GCC的文件，例如x86_64-conda_cos6-linux-gnu-gcc，可以创建一个软链接：
ln -sf $CONDA_PREFIX/bin/x86_64-conda_cos6-linux-gnu-gcc $CONDA_PREFIX/bin/gcc
# 6、确保Conda环境的bin目录在PATH环境变量的前面：
export PATH=$CONDA_PREFIX/bin:$PATH
# 7、检查gcc版本：
gcc --version
## 通常情况下，g++需要与gcc版本匹配，g++的版本安装与上述过程相同。过程中碰到了其他包的依赖版本问题，也需要去上述链接中查询对应版本。
```

##### 虚拟环境

```sh
# 导出虚拟环境
conda env export > environment.yml
# 加载虚拟环境
conda env create -f environment.yml
# 中断后可继续加载
conda env update -n env_name -f environment.yaml
# 导出特定包版本
conda list --export > requirements.txt
# 导出纯净的pip版本
pip list --format=freeze | grep -v "@" > requirements.txt
pip install -r requirements.txt
	## 使用pip install -r requirements.txt安装时，遇到各种报错中断，使用该命令不中断，能基本安装常用的包，并且使用ctrl+c时可以中断正在下载的包
while read -r package; do
    pip install "$package" || echo "跳过安装失败包: $package"
done < requirements.txt
```



# Git操作

##### git删除文件

```sh
## 直接用git rm会删除本地文件
# 1、删除本地 2、删除远程 3、提交
rm file
git rm file
git commit -m "delete"
git push
# 删除.DS_Store
find . -name .DS_Store -delete
git commit -u
git push
# 删除暂存区.DS_Store
git rm --cached **/.DS_Store
# 删除暂存区文件夹
git rm -r --cached dir
```

##### git本地有修改时，拉取不覆盖

```sh
# 1、暂存本地修改
git stash
# 2、拉取远程更新
git pull
# 3、恢复暂存的修改（可能需手动解决冲突）
git stash pop
### 慎用，会删除本地修改，基本等同于删除后重新拉取
git fetch origin
git reset --hard origin/main
git clean -fd
```

##### git修改文件名称

```sh
git mv file1 file2
git commit -m "update"
git push
```

##### 添加.gitignore

```sh
# 创建 .gitignore
vim .gitignore
# 添加忽略关键词
*.pyc
__pycache__/
# 提交、推送
git add .gitignore
git commit -m "Ignore .pyc and __pycache__ files"
git push
```

##### git仓库地址

```sh
# 当前仓库名称
git remote
output >> origin（默认）
# 查看当前远程仓库地址
git remote -v
# 修改远程仓库地址
git remote set-url origin <newurl>
# 删除 -> 添加
git remote remove origin
git remote add origin <url>
```

##### git无法clone

```sh
# 报错：The project you were looking for could not be found（确保权限正确）
# 方法一：临时使用用户名密码
git clone http://username:password@gitlab.com/project/xxxx.git
# 方法二：重置用户名密码
git config --system --unset  credential.helper # Windows
git config --global --unset credential.helper # Mac
```

##### git clone超时，无法ping通github.com

```sh
# 1、添加DNS服务器
sudo vim /etc/resolv.conf
nameserver 8.8.8.8       # Google DNS
nameserver 1.1.1.1       # Cloudflare DNS
# 2、添加github的ip
sudo vim /etc/hosts
140.82.112.3 github.com
151.101.1.194 github.global.ssl.fastly.net
source /etc/hosts
 ## 可以通过这个网址查询这个动态ip
 https://www.ipaddress.com/website/github.com/
 https://www.ipaddress.com/website/github.global.ssl.fastly.net/
# 3、将ssh公钥添加到github账户
ssh-genkey
cd ~/.ssh
cat id_rsa.pub
# 进入github账户->setting->SSH and GPG keys->New SSH key
自定义title：jiyunqi:192.168.210.90
Key：id_rsa.pub中的密钥内容
```

##### linux同一个账户连接不同git user时

```sh
# 1、生成新的密钥
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa_jiyunqi -C "jiyunqi@hisign.com.cn"
# 2、将公钥添加到gitlab账户
# 3、在~/.ssh下的config文件里
Host 192.168.210.9
    HostName 192.168.210.9
    User git
    IdentityFile ~/.ssh/id_rsa_jiyunqi
## Host可以修改为任意名，此时该账户下使用类似git@192.168.210.9:jiyunqi/hisignlivedet.git时会自动映射我的密钥
```

